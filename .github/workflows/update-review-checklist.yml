name: Update Review Checklist
on:
  pull_request:
    types: [opened, synchronize]  # PRä½œæˆæ™‚ã¨æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆæ™‚

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  update-checklist:
    runs-on: ubuntu-latest
    steps:
      - name: Update verification checklist
        uses: actions/github-script@v6
        with:
          script: |
            // éå»ã®è‡ªå‹•ç”Ÿæˆã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ï¼ˆPRä½œæˆå¾Œã®ã‚³ãƒŸãƒƒãƒˆæ™‚ã®ã¿ï¼‰
            if (context.payload.action === 'synchronize') {
              const comments = await github.rest.issues.listComments({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
              });
              
              const botComments = comments.data.filter(comment => 
                comment.user.login === 'github-actions[bot]' && 
                (comment.body.includes('ğŸ“ ä¿®æ­£å®Œäº†ãƒã‚§ãƒƒã‚¯') || comment.body.includes('ğŸ“ PRä½œæˆæ™‚ã®ãƒã‚§ãƒƒã‚¯'))
              );
              
              // éå»ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
              for (const comment of botComments) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: comment.id,
                });
              }
            }
            
            // ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚’å–å¾—
            const commitSha = context.payload.pull_request.head.sha;
            const shortSha = commitSha.substring(0, 7);
            
            // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            const actionText = context.payload.action === 'opened' 
              ? 'PRä½œæˆæ™‚ã®ãƒã‚§ãƒƒã‚¯' 
              : 'ä¿®æ­£å®Œäº†ãƒã‚§ãƒƒã‚¯';
            
            // æ–°ã—ã„ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’è¿½åŠ 
            const newComment = `## ğŸ“ ${actionText} (${new Date().toLocaleString('ja-JP', {timeZone: 'Asia/Tokyo'})})
            
            **æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆ:** \`${shortSha}\`
            
            ä½œæˆè€…/ä¿®æ­£è€…ã¯ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š
            - [ ] ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®å‹•ä½œç¢ºèªæ¸ˆã¿
            - [ ] é–¢é€£ã™ã‚‹ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªæ¸ˆã¿
            - [ ] æ„å›³ã—ãŸæ©Ÿèƒ½/ä¿®æ­£ãŒæ­£ã—ãåæ˜ ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªæ¸ˆã¿
            - [ ] ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚„ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªæ¸ˆã¿
            
            âœ… **ç¢ºèªå®Œäº†å¾Œã€ä¸Šè¨˜ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«ã™ã¹ã¦ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚**
            
            ---
            *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ã¨è‡ªå‹•ã§æ›´æ–°ã•ã‚Œã¾ã™ã€‚*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: newComment
            });