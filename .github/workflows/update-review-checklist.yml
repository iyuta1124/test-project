name: Update Review Checklist
on:
  pull_request_review:
    types: [submitted] # レビューが提出された時のみ

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  update-checklist:
    runs-on: ubuntu-latest
    # CHANGES_REQUESTED以外とセルフレビューを除外
    if: |
      github.event.review.user.login != github.event.pull_request.user.login &&
      github.event.review.state == 'CHANGES_REQUESTED'
    steps:
      - name: Update verification checklist
        uses: actions/github-script@v6
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComments = comments.data.filter(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('📝 再修正完了チェック')
            );

            // 過去の自動生成コメントを削除
            for (const comment of botComments) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: comment.id,
              });
            }

            // コミット情報を取得
            const commitSha = context.payload.pull_request.head.sha;
            const shortSha = commitSha.substring(0, 7);

            // 新しいチェックリストを追加
            const newComment = `## 📝 再修正完了チェック (**最新のコミット:** \`${shortSha}\`)

            - [ ] 再修正による劣化が発生していないことを確認した
            - [ ] レビュワーからの指摘に対して、対応漏れがないことを確認した
            - [ ] 対応不要と判断した指摘に対して、その旨をレビュワーに伝えた

            ✅ **上記のチェックボックスにすべてチェックを入れてから再度レビュー依頼をしてください**

            ---
            *このコメントは新しいコミットがプッシュされると自動で更新されます。*`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: newComment
            });
