name: Update Review Checklist
on:
  pull_request_review:
    types: [submitted] # ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒæå‡ºã•ã‚ŒãŸæ™‚ã®ã¿

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  update-checklist:
    runs-on: ubuntu-latest
    # CHANGES_REQUESTEDä»¥å¤–ã¨ã‚»ãƒ«ãƒ•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é™¤å¤–
    if: |
      github.event.review.user.login != github.event.pull_request.user.login &&
      github.event.review.state == 'CHANGES_REQUESTED'
    steps:
      - name: Update verification checklist
        uses: actions/github-script@v6
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComments = comments.data.filter(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('ğŸ“ å†ä¿®æ­£å®Œäº†ãƒã‚§ãƒƒã‚¯')
            );

            // éå»ã®è‡ªå‹•ç”Ÿæˆã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
            for (const comment of botComments) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: comment.id,
              });
            }

            // ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚’å–å¾—
            const commitSha = context.payload.pull_request.head.sha;
            const shortSha = commitSha.substring(0, 7);

            // æ–°ã—ã„ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’è¿½åŠ 
            const newComment = `## ğŸ“ å†ä¿®æ­£å®Œäº†ãƒã‚§ãƒƒã‚¯ (**æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆ:** \`${shortSha}\`)

            - [ ] å†ä¿®æ­£ã«ã‚ˆã‚‹åŠ£åŒ–ãŒç™ºç”Ÿã—ã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªã—ãŸ
            - [ ] ãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼ã‹ã‚‰ã®æŒ‡æ‘˜ã«å¯¾ã—ã¦ã€å¯¾å¿œæ¼ã‚ŒãŒãªã„ã“ã¨ã‚’ç¢ºèªã—ãŸ
            - [ ] å¯¾å¿œä¸è¦ã¨åˆ¤æ–­ã—ãŸæŒ‡æ‘˜ã«å¯¾ã—ã¦ã€ãã®æ—¨ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼ã«ä¼ãˆãŸ

            âœ… **ä¸Šè¨˜ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«ã™ã¹ã¦ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ã‹ã‚‰å†åº¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼ã‚’ã—ã¦ãã ã•ã„**

            ---
            *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ã¨è‡ªå‹•ã§æ›´æ–°ã•ã‚Œã¾ã™ã€‚*`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: newComment
            });
