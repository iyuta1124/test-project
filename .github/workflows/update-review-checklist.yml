name: Update Review Checklist
on:
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [synchronize]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  update-checklist:
    runs-on: ubuntu-latest
    # CHANGES_REQUESTEDã‚’å—ã‘ãŸå¾Œã®ã‚³ãƒŸãƒƒãƒˆã€ã¾ãŸã¯CHANGES_REQUESTEDãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚ã®ã¿å®Ÿè¡Œ
    if: |
      (github.event_name == 'pull_request_review' && 
       github.event.review.user.login != github.event.pull_request.user.login &&
       github.event.review.state == 'CHANGES_REQUESTED') ||
      (github.event_name == 'pull_request' && 
       github.event.action == 'synchronize')
    steps:
      - name: Check if checklist is needed
        id: check-need
        uses: actions/github-script@v6
        with:
          script: |
            if (context.eventName === 'pull_request_review') {
              return true;  // ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚ã¯å¿…ãšå®Ÿè¡Œ
            }

            // ã‚³ãƒŸãƒƒãƒˆæ™‚ã¯éå»ã«CHANGES_REQUESTEDãŒã‚ã£ãŸå ´åˆã®ã¿å®Ÿè¡Œ
            const reviews = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const hasChangesRequested = reviews.data.some(review => 
              review.state === 'CHANGES_REQUESTED'
            );

            return hasChangesRequested;

      - name: Update verification checklist
        if: steps.check-need.outputs.result == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComments = comments.data.filter(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('ğŸ“ å†ä¿®æ­£å®Œäº†ãƒã‚§ãƒƒã‚¯')
            );

            // éå»ã®è‡ªå‹•ç”Ÿæˆã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
            for (const comment of botComments) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: comment.id,
              });
            }

            // ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚’å–å¾—
            const commitSha = context.payload.pull_request.head.sha;
            const shortSha = commitSha.substring(0, 7);

            // æ–°ã—ã„ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’è¿½åŠ 
            const newComment = `## ğŸ“ å†ä¿®æ­£å®Œäº†ãƒã‚§ãƒƒã‚¯ (**æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆ:** \`${shortSha}\`)

            - [ ] å†ä¿®æ­£å¾Œã®å‹•ä½œç¢ºèªã‚’å®Ÿæ–½ã—ã€åŠ£åŒ–ãŒç™ºç”Ÿã—ã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªã—ãŸ
            - [ ] ãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼ã‹ã‚‰ã®æŒ‡æ‘˜ã«å¯¾ã—ã¦ã€å¯¾å¿œæ¼ã‚ŒãŒãªã„ã“ã¨ã‚’ç¢ºèªã—ãŸ
            - [ ] å¯¾å¿œä¸è¦ã¨åˆ¤æ–­ã—ãŸæŒ‡æ‘˜ãŒã‚ã‚‹å ´åˆã€ç†ç”±ã‚’æ˜è¨˜ã—ã¦è¿”ä¿¡ã—ãŸ

            âœ… **ä¸Šè¨˜ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«ã™ã¹ã¦ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ã‹ã‚‰å†åº¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼ã‚’ã—ã¦ãã ã•ã„**

            ---
            *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ã¨è‡ªå‹•ã§æ›´æ–°ã•ã‚Œã¾ã™ã€‚*`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: newComment
            });
